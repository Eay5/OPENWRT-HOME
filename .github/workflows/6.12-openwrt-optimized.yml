name: Build 6.12-OpenWrt-Optimized

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: "SSH connection to Actions"
        required: false
        default: "false"
      cache:
        description: "Enable cache (experimental)"
        required: false
        default: "false"
  schedule:
    - cron: 0 19 * * *  # 每天 19:00 UTC（即 Asia/Shanghai 的 03:00）

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: 6.12-optimized.config
  DIY_P1_SH: 6.12-part1.sh
  DIY_P2_SH: 6.12-part2-optimized.sh
  UPLOAD_BIN_DIR: false  # 禁用bin目录上传（节省空间）
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false  # 禁用不必要的上传
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      # 检查项目分支
      - name: 检查项目分支
        uses: actions/checkout@v4

      # 优化磁盘空间清理
      - name: 深度清理磁盘空间
        run: |
          echo "清理前磁盘使用："
          df -hT
          
          # 移除大型不需要的包
          sudo apt-get remove -y '^aspnetcore-.*' '^dotnet-.*' '^llvm-.*' 'php.*' '^mongodb-.*' '^mysql-.*' \
            azure-cli google-chrome-stable firefox powershell mono-devel libgl1-mesa-dri --autoremove
          
          # 清理 Docker
          docker rmi $(docker images -q) 2>/dev/null || true
          
          # 清理大型目录
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android /opt/ghc \
            /usr/local/share/boost /usr/local/julia* /usr/share/swift /usr/local/share/edge_driver \
            /usr/local/share/chromedriver-linux64 /usr/local/share/gecko_driver /usr/share/miniconda \
            /usr/share/az_* /usr/share/gradle-* /opt/hostedtoolcache/CodeQL /usr/local/aws-cli
          
          # 清理 APT 缓存
          sudo apt-get clean
          sudo apt-get autoclean
          sudo apt-get autoremove --purge -y
          
          # 创建工作目录
          sudo mkdir -p /workdir
          sudo chown $USER:$(id -gn) /workdir
          
          echo "清理后磁盘使用："
          df -hT

      # 可选缓存（实验性）
      - name: 设置缓存（可选）
        if: github.event.inputs.cache == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
            openwrt/staging_dir/toolchain-*
            openwrt/staging_dir/host
            openwrt/dl
          key: ${{ runner.os }}-cache-6.12-opt-${{ hashFiles('**/6.12-optimized.config') }}
          restore-keys: |
            ${{ runner.os }}-cache-6.12-opt-

      # 精简安装编译环境
      - name: 安装编译环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-mark hold grub-efi-amd64-signed
          sudo -E apt update
          sudo -E apt -y install --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3-setuptools rsync \
            swig unzip zlib1g-dev file wget libelf-dev autoconf automake \
            libtool cmake ninja-build ccache
          sudo -E systemctl daemon-reload
          sudo -E timedatectl set-timezone "$TZ"
          
          # 配置 ccache（如果启用缓存）
          if [ "${{ github.event.inputs.cache }}" = "true" ]; then
            export PATH="/usr/lib/ccache:$PATH"
            ccache -M 5G
            ccache -z
            echo "已启用 ccache 加速"
          fi

      # 下载固件源码（使用深度1减少下载量）
      - name: 下载固件源码
        run: |
          df -hT $PWD
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
          cd openwrt
          echo "src-git lede https://github.com/coolsnowwolf/lede.git^$(git rev-parse HEAD)" >> feeds.conf.default
          echo "源码版本: $(git log -1 --format='%h %s')"

      # 加载自定义设置
      - name: 加载自定义设置
        run: |
          [ -e "$FEEDS_CONF" ] && mv "$FEEDS_CONF" openwrt/feeds.conf.default
          chmod +x "$DIY_P1_SH"
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH

      # 更新 feeds（优化）
      - name: 更新 feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a -j$(nproc)

      # 清理冲突包（优化版）
      - name: 清理冲突包
        run: |
          cd openwrt
          echo "清理冲突包..."
          
          # 批量删除冲突包
          find feeds/small -name "base-files" -o -name "dnsmasq" -o -name "firewall*" \
            -o -name "fullconenat" -o -name "libnftnl" -o -name "nftables" \
            -o -name "ppp" -o -name "opkg" -o -name "ucl" -o -name "upx" \
            -o -name "vsftpd*" -o -name "miniupnpd-iptables" \
            -o -name "wireless-regdb" | xargs rm -rf
          
          # 删除重复应用
          rm -rf feeds/{luci,kenzo}/applications/luci-app-{ssr-plus,mosdns,fchomo,bypass}
          rm -rf feeds/small/luci-app-ssr-plus
          
          # 删除官方源冲突包
          rm -rf feeds/packages/net/{alist,adguardhome,mosdns,xray*,v2ray*,sing*,smartdns}
          rm -rf feeds/packages/net/{shadowsocks-libev,shadowsocksr-libev,simple-obfs}
          rm -rf feeds/packages/utils/v2dat
          
          # 替换 golang
          rm -rf feeds/packages/lang/golang
          git clone --depth 1 https://github.com/kenzok8/golang -b 1.25 feeds/packages/lang/golang
          
          echo "冲突包清理完成"

      # 安装 feeds（优化）
      - name: 安装 feeds
        run: |
          cd openwrt
          ./scripts/feeds install -a -j$(nproc)

      # 自定义配置
      - name: 自定义配置
        run: |
          [ -e files ] && mv files openwrt/files
          [ -e "$CONFIG_FILE" ] && mv "$CONFIG_FILE" openwrt/.config
          chmod +x "$DIY_P2_SH"
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P2_SH

      # 生成配置
      - name: 生成配置
        run: |
          cd openwrt
          make defconfig
          
          # 显示关键配置
          echo "=== 关键配置确认 ==="
          grep -E "CONFIG_TARGET_x86|CONFIG_KERNEL|BBR|VIRTIO|SSR|MOSDNS|SMARTDNS" .config | head -20

      # SSH 连接（调试用）
      - name: SSH 连接管理
        uses: P3TERX/ssh2actions@v1.0.0
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh != 'false')
        env:
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

      # 下载包（智能重试）
      - name: 下载编译所需包
        run: |
          cd openwrt
          
          # 首次尝试并行下载
          make download -j8 V=s 2>&1 | tee download.log || {
            echo "部分下载失败，清理并重试..."
            # 清理损坏的文件
            find dl -size -1024c -exec rm -f {} \;
            # 单线程重试失败的下载
            make download -j1 V=s
          }
          
          # 最终检查
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          
          echo "下载完成，包总数: $(ls -1 dl | wc -l)"

      # 编译工具链（分步优化）
      - name: 编译工具链
        run: |
          cd openwrt
          
          # 使用 ccache 加速（如果启用）
          if [ "${{ github.event.inputs.cache }}" = "true" ]; then
            export PATH="/usr/lib/ccache:$PATH"
            export CCACHE_DIR=~/.ccache
            echo "CONFIG_CCACHE=y" >> .config
          fi
          
          # 分步编译工具链
          echo "编译基础工具..."
          make tools/compile -j$(nproc) V=s || make tools/compile -j1 V=s
          
          echo "编译交叉工具链..."
          make toolchain/compile -j$(nproc) V=s || make toolchain/compile -j1 V=s
          
          echo "编译内核..."
          make target/linux/compile -j$(nproc) V=s || make target/linux/compile -j1 V=s

      # 编译固件（优化版）
      - name: 编译固件
        id: compile
        run: |
          cd openwrt
          
          # 设置编译参数
          if [ "${{ github.event.inputs.cache }}" = "true" ]; then
            export PATH="/usr/lib/ccache:$PATH"
            export CCACHE_DIR=~/.ccache
          fi
          
          # 计算最优线程数
          THREADS=$(($(nproc) + 1))
          echo "使用 $THREADS 线程编译（CPU核心: $(nproc)）"
          
          # 开始编译
          echo "开始编译固件..."
          make -j$THREADS V=s 2>&1 | tee build.log || {
            echo "编译失败，尝试单线程编译问题包..."
            make -j1 V=s 2>&1 | tee -a build.log
          }
          
          # 检查结果
          echo "status=success" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
          
          # 显示固件信息
          echo "=== 生成的固件 ==="
          ls -lh bin/targets/*/*/*.gz 2>/dev/null || true
          
          # 显示编译统计
          if [ "${{ github.event.inputs.cache }}" = "true" ]; then
            echo "=== ccache 统计 ==="
            ccache -s
          fi

      # 检查空间
      - name: 检查磁盘空间
        if: (!cancelled())
        run: df -hT

      # 整理固件
      - name: 整理固件
        id: organize
        if: env.status == 'success' && !cancelled()
        run: |
          cd openwrt/bin/targets/*/*
          
          # 删除不需要的文件
          rm -rf packages *.buildinfo *.manifest *.bin
          
          # 重命名固件
          for file in *.gz; do
            [ -f "$file" ] && mv "$file" "OpenWrt-6.12-x86_64-$(date +%Y%m%d)-${file}"
          done
          
          # 生成固件信息
          cat > firmware_info.txt << EOF
          固件信息
          ========
          编译时间: $(date +"%Y-%m-%d %H:%M:%S")
          内核版本: 6.12
          目标平台: x86_64
          优化级别: -O3 -march=x86-64-v2
          
          主要特性:
          - SSR-Plus (Shadowsocks-Rust)
          - MosDNS (主DNS)
          - SmartDNS (辅DNS)
          - TCP BBR
          - VirtIO 全驱动
          - Shortcut-FE 加速
          
          默认设置:
          - IP地址: 192.168.0.133
          - 用户名: root
          - 密码: (空)
          EOF
          
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_ENV

      # 上传固件
      - name: 上传固件到 Actions
        uses: actions/upload-artifact@v4
        if: env.status == 'success' && !cancelled()
        with:
          name: OpenWrt-6.12-Optimized${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      # 发布 Release
      - name: 发布 Release
        uses: softprops/action-gh-release@v2
        if: env.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: OpenWrt 6.12 优化版 ${{ env.FILE_DATE }}
          tag_name: v6.12-opt-$(date +"%Y%m%d")
          body_path: ${{ env.FIRMWARE }}/firmware_info.txt
          files: ${{ env.FIRMWARE }}/*.gz
          draft: false
          prerelease: false

      # 清理工作流
      - name: 清理旧的工作流
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 7
          keep_minimum_runs: 3

      # 清理旧版本
      - name: 清理旧版本
        uses: dev-drprasad/delete-older-releases@master
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        with:
          repo: ${{ github.repository }}
          keep_latest: 5
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
