name: Build 6.12-OpenWrt-Optimized

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: "SSH connection to Actions"
        required: false
        default: "false"
  schedule:
    - cron: 0 19 * * *
  watch:
    types: [started]

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: 6.12-optimized.config
  DIY_P1_SH: 6.12-part1.sh
  DIY_P2_SH: 6.12-part2-optimized.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: 检查项目分支
        uses: actions/checkout@v4

      - name: 清理磁盘空间
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo apt-get -qq purge azure-cli* ghc* zulu* llvm* firefox google* powershell* openjdk* mongodb* moby* || true
          sudo apt-get -qq autoremove --purge
          sudo apt-get -qq clean
          df -hT

      - name: 安装编译环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib \
            g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev \
            libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev \
            libpython3-dev libreadline-dev libssl-dev libtool lld llvm lrzsz mkisofs msmtp nano ninja-build \
            p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils python3-pyelftools \
            qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs unzip upx-ucl vim \
            wget xmlto xxd zlib1g-dev zstd
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"

      - name: 配置 ccache 加速
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: openwrt-6.12-${{ github.sha }}
          restore-keys: |
            openwrt-6.12-
          max-size: 2G

      - name: 下载源码
        run: |
          df -hT $PWD
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt

      - name: 加载自定义 feeds
        run: |
          [ -e "$FEEDS_CONF" ] && cp "$FEEDS_CONF" openwrt/feeds.conf.default
          chmod +x "$DIY_P1_SH"
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH

      - name: 更新 feeds
        run: cd openwrt && ./scripts/feeds update -a

      - name: 清理冲突包
        run: |
          cd openwrt
          # 清理基础冲突包
          rm -rf feeds/small/{base-files,dnsmasq,firewall*,fullconenat,libnftnl,nftables,ppp,opkg,ucl,upx,miniupnpd-iptables,wireless-regdb}
          
          # 清理有依赖问题的包（vsftpd、dogcom、webd 等）
          rm -rf feeds/small/{vsftpd*,luci-app-vsftpd,dogcom,luci-app-dogcom,webd,luci-app-webd}
          rm -rf feeds/small/{luci-app-tencentcloud-cos,transmission,luci-app-transmission}
          rm -rf feeds/small/{natflow,nginx,luci-app-nginx*}
          
          # 清理代理相关冲突
          rm -rf feeds/luci/applications/{luci-app-ssr-plus,luci-app-mosdns,luci-app-fchomo,luci-app-bypass}
          rm -rf feeds/kenzo/{luci-app-ssr-plus,luci-app-fchomo,luci-app-bypass}
          rm -rf feeds/small/luci-app-ssr-plus 2>/dev/null || true
          rm -rf feeds/packages/net/{alist,adguardhome,mosdns,xray*,v2ray*,sing*,smartdns,shadowsocks-libev,shadowsocksr-libev,simple-obfs}
          rm -rf feeds/packages/utils/v2dat feeds/packages/lang/golang
          
          # 更新 golang
          git clone --depth 1 https://github.com/kenzok8/golang -b 1.25 feeds/packages/lang/golang

      - name: 安装 feeds
        run: cd openwrt && ./scripts/feeds install -a

      - name: 设置内核版本
        run: |
          cd openwrt
          sed -i 's/KERNEL_PATCHVER:=.*/KERNEL_PATCHVER:=6.12/g' target/linux/x86/Makefile

      - name: 加载配置
        run: |
          [ -e files ] && cp -r files openwrt/files
          cp "$CONFIG_FILE" openwrt/.config
          chmod +x "$DIY_P2_SH"
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P2_SH

      - name: 生成配置
        run: |
          cd openwrt
          make defconfig
          sed -i 's/KERNEL_PATCHVER:=.*/KERNEL_PATCHVER:=6.12/g' target/linux/x86/Makefile

      - name: SSH 调试
        uses: P3TERX/ssh2actions@v1.0.0
        if: github.event.inputs.ssh == 'true'
        env:
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

      - name: 下载软件包
        run: |
          cd openwrt
          make download -j$(nproc) || make download -j1 V=s
          find dl -size -1024c -delete

      - name: 编译工具链
        run: |
          cd openwrt
          echo "编译线程数: $(nproc)"
          make tools/install -j$(nproc) || make tools/install -j1 V=s
          make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s

      - name: 编译固件
        id: compile
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          echo "DEVICE_NAME=x86-64" >> $GITHUB_ENV
          echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: 检查磁盘
        if: always()
        run: df -hT

      - name: 上传构建日志
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-logs
          path: |
            openwrt/.config
            openwrt/logs/

      - name: 整理固件
        id: organize
        if: steps.compile.outputs.status == 'success'
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages *.buildinfo *.manifest sha256sums
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: 上传固件
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.status == 'success'
        with:
          name: OpenWrt-6.12-Bypass_${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: 生成 Release 信息
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success'
        run: |
          echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV
          cat > release.txt << 'EOF'
          ## OpenWrt 6.12 旁路由专用版
          
          ### 系统信息
          - 内核: 6.12 | 平台: x86_64
          - 默认 IP: 192.168.0.133
          - 用途: 旁路由（透明代理 + DNS 分流）
          
          ### 核心功能
          - SSR-Plus + Xray + Shadowsocks-Rust
          - MosDNS + SmartDNS
          - TCP BBR + SFE 加速
          
          ### 使用说明
          1. 导入虚拟机，设置静态 IP
          2. 关闭 DHCP，网关指向主路由
          3. 客户端网关/DNS 指向此旁路由
          EOF

      - name: 发布 Release
        uses: softprops/action-gh-release@v2
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.release_tag }}
          name: OpenWrt-6.12-Bypass_${{ env.FILE_DATE }}
          body_path: release.txt
          files: ${{ env.FIRMWARE }}/*

      - name: 清理旧 Releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        if: env.UPLOAD_RELEASE == 'true'
        with:
          keep_latest: 5
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 清理旧工作流
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 1
          keep_minimum_runs: 3
