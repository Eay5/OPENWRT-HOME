# ==================================================
# OpenWrt 6.12 极致精简虚拟机专用版
# 适用于 KVM / QEMU / Proxmox / VMware / Hyper-V
# 包含：SSR-Plus（Rust版） + MosDNS + SmartDNS + Xray/Trojan
# ==================================================

CONFIG_MODULES=y
CONFIG_HAVE_DOT_CONFIG=y

# ┌─────────────────────────────────────────────┐
# │ 目标平台（x86_64 通用虚拟机）                 │
# └─────────────────────────────────────────────┘
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_generic=y

# ┌─────────────────────────────────────────────┐
# │ 镜像格式与分区大小                            │
# └─────────────────────────────────────────────┘
CONFIG_GRUB_IMAGES=y
CONFIG_GRUB_TIMEOUT="3"
CONFIG_GRUB_TITLE="OpenWrt 6.12 VM Optimized"
CONFIG_PACKAGE_grub2-efi=y
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_TARGET_ROOTFS_PARTSIZE=1024      # 根分区 1GB
CONFIG_TARGET_KERNEL_PARTSIZE=32
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_SQUASHFS_BLOCK_SIZE=256

# ┌─────────────────────────────────────────────┐
# │ 内核与虚拟化优化                              │
# └─────────────────────────────────────────────┘
CONFIG_VIRTUALIZATION=y
CONFIG_KVM_GUEST=y
CONFIG_PARAVIRT=y
CONFIG_PARAVIRT_SPINLOCKS=y
CONFIG_HYPERVISOR_GUEST=y

# CPU 优化
CONFIG_CPU_FREQ=y
CONFIG_CPU_FREQ_DEFAULT_GOV_PERFORMANCE=y
CONFIG_CPU_FREQ_GOV_PERFORMANCE=y
CONFIG_CPU_FREQ_GOV_ONDEMAND=y

# 内存优化（虚拟机最重要）
CONFIG_TRANSPARENT_HUGEPAGE=y
CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS=y
CONFIG_ZSWAP=y
CONFIG_ZPOOL=y
CONFIG_Z3FOLD=y
CONFIG_PACKAGE_zram-swap=y

# ┌─────────────────────────────────────────────┐
# │ 虚拟机必备驱动（VirtIO）                      │
# └─────────────────────────────────────────────┘
CONFIG_PACKAGE_kmod-virtio=y
CONFIG_PACKAGE_kmod-virtio-net=y
CONFIG_PACKAGE_kmod-virtio-blk=y
CONFIG_PACKAGE_kmod-virtio-scsi=y
CONFIG_PACKAGE_kmod-virtio-balloon=y
CONFIG_PACKAGE_kmod-virtio-random=y

# 兼容性网卡（可选保留 e1000/e1000e）
CONFIG_PACKAGE_kmod-e1000=y
CONFIG_PACKAGE_kmod-e1000e=y

# 禁用物理硬件驱动（虚拟机完全用不到）
CONFIG_PACKAGE_kmod-igc=n
CONFIG_PACKAGE_kmod-r8125=n
CONFIG_PACKAGE_kmod-r8168=n
CONFIG_PACKAGE_kmod-ixgbe=n
CONFIG_PACKAGE_kmod-igb=n
CONFIG_PACKAGE_kmod-i40e=n
CONFIG_PACKAGE_kmod-iavf=n

# ┌─────────────────────────────────────────────┐
# │ 网络加速与 TCP 优化                           │
# └─────────────────────────────────────────────┘
CONFIG_PACKAGE_kmod-tcp-bbr=y
CONFIG_PACKAGE_kmod-tcp-hybla=y
CONFIG_PACKAGE_kmod-shortcut-fe=y
CONFIG_PACKAGE_kmod-shortcut-fe-cm=y
CONFIG_PACKAGE_kmod-fast-classifier=y
CONFIG_PACKAGE_TURBOACC_INCLUDE_SHORTCUT_FE=y
CONFIG_PACKAGE_TURBOACC_INCLUDE_BBR_CCA=y

# IPv6 支持（保留完整）
CONFIG_PACKAGE_ipv6helper=y
CONFIG_PACKAGE_odhcpd-ipv6only=y
CONFIG_PACKAGE_odhcp6c=y
CONFIG_PACKAGE_6in4=y
CONFIG_PACKAGE_6rd=y
CONFIG_PACKAGE_6to4=y

# ┌─────────────────────────────────────────────┐
# │ 防火墙与透明代理必备                          │
# └─────────────────────────────────────────────┘
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_iptables-mod-tproxy=y
CONFIG_PACKAGE_iptables-mod-extra=y
CONFIG_PACKAGE_iptables-mod-nat-extra=y
CONFIG_PACKAGE_iptables-mod-conntrack-extra=y
CONFIG_PACKAGE_kmod-ipt-tproxy=y
CONFIG_PACKAGE_kmod-ipt-nat=y
CONFIG_PACKAGE_kmod-ipt-conntrack=y
CONFIG_PACKAGE_kmod-nf-conntrack=y
CONFIG_PACKAGE_kmod-nf-conntrack-netlink=y

# ┌─────────────────────────────────────────────┐
# │ SSR-Plus 全家桶（Rust 版性能最强）            │
# └─────────────────────────────────────────────┘
CONFIG_PACKAGE_luci-app-ssr-plus=y
CONFIG_PACKAGE_luci-i18n-ssr-plus-zh-cn=y

# Shadowsocks Rust（推荐）
CONFIG_PACKAGE_shadowsocks-rust=y
CONFIG_PACKAGE_shadowsocks-rust-sslocal=y
CONFIG_PACKAGE_shadowsocks-rust-ssserver=y
CONFIG_PACKAGE_shadowsocks-rust-ssurl=y
CONFIG_PACKAGE_shadowsocks-rust-ssmanager=y

# SSR 原版（兼容性）
CONFIG_PACKAGE_shadowsocksr-libev=y
CONFIG_PACKAGE_shadowsocksr-libev-ssr-local=y
CONFIG_PACKAGE_shadowsocksr-libev-ssr-redir=y
CONFIG_PACKAGE_shadowsocksr-libev-ssr-server=y
CONFIG_PACKAGE_shadowsocksr-libev-ssr-check=y

# Xray / V2ray 精简版
CONFIG_PACKAGE_xray-core=y
CONFIG_PACKAGE_xray-plugin=y
CONFIG_PACKAGE_v2ray-geoip=y
CONFIG_PACKAGE_v2ray-geosite=y

# Trojan
CONFIG_PACKAGE_trojan-plus=y
CONFIG_PACKAGE_trojan-go=y

# 混淆插件
CONFIG_PACKAGE_simple-obfs=y
CONFIG_PACKAGE_simple-obfs-client=y
CONFIG_PACKAGE_kcptun-client=y
CONFIG_PACKAGE_kcptun-config=y

# 透明代理工具
CONFIG_PACKAGE_redsocks2=y
CONFIG_PACKAGE_microsocks=y
CONFIG_PACKAGE_ipt2socks=y
CONFIG_PACKAGE_dns2socks=y
CONFIG_PACKAGE_dns2tcp=y

# 分流工具
CONFIG_PACKAGE_chinadns-ng=y
CONFIG_PACKAGE_pdnsd-alt=y
CONFIG_PACKAGE_tcping=y
CONFIG_PACKAGE_resolveip=y

# ┌─────────────────────────────────────────────┐
# │ MosDNS + SmartDNS（双DNS最优组合）            │
# └─────────────────────────────────────────────┘
CONFIG_PACKAGE_mosdns=y
CONFIG_PACKAGE_luci-app-mosdns=y
CONFIG_PACKAGE_luci-i18n-mosdns-zh-cn=y

CONFIG_PACKAGE_smartdns=y
CONFIG_PACKAGE_luci-app-smartdns=y
CONFIG_PACKAGE_luci-i18n-smartdns-zh-cn=y

# DNS 工具
CONFIG_PACKAGE_bind-dig=y
CONFIG_PACKAGE_bind-host=y
CONFIG_PACKAGE_drill=y

# dnsmasq-full（必须完整版支持 nftset/ipset）
CONFIG_PACKAGE_dnsmasq-full=y
CONFIG_PACKAGE_dnsmasq_full_dhcp=y
CONFIG_PACKAGE_dnsmasq_full_dhcpv6=y
CONFIG_PACKAGE_dnsmasq_full_dnssec=y
CONFIG_PACKAGE_dnsmasq_full_auth=y
CONFIG_PACKAGE_dnsmasq_full_ipset=y
CONFIG_PACKAGE_dnsmasq_full_nftset=y
CONFIG_PACKAGE_dnsmasq_full_conntrack=y
CONFIG_PACKAGE_dnsmasq_full_noid=y
CONFIG_PACKAGE_dnsmasq_full_broken_rtc=y
CONFIG_PACKAGE_dnsmasq_full_tftp=y

# ┌─────────────────────────────────────────────┐
# │ 基础工具与系统优化                            │
# └─────────────────────────────────────────────┘
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_wget-ssl=y
CONFIG_PACKAGE_nano=y
CONFIG_PACKAGE_htop=y
CONFIG_PACKAGE_iftop=y
CONFIG_PACKAGE_nload=y
CONFIG_PACKAGE_vnstat=y
CONFIG_PACKAGE_tcpdump=y
CONFIG_PACKAGE_iperf3=y
CONFIG_PACKAGE_mtr=y
CONFIG_PACKAGE_ss=y
CONFIG_PACKAGE_lsof=y

CONFIG_PACKAGE_openssh-sftp-server=y
CONFIG_PACKAGE_openssh-client=y
CONFIG_PACKAGE_openssh-keygen=y

CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_e2fsprogs=y

# ┌─────────────────────────────────────────────┐
# │ LuCI 界面（中文 + Argon 主题）                │
# └─────────────────────────────────────────────┘
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-mod-admin-full=y
CONFIG_PACKAGE_luci-theme-argon=y
CONFIG_PACKAGE_luci-app-argon-config=y
CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y
CONFIG_PACKAGE_luci-i18n-opkg-zh-cn=y
CONFIG_PACKAGE_luci-proto-ipv6=y
CONFIG_PACKAGE_luci-proto-ppp=y

# ┌─────────────────────────────────────────────┐
# │ 彻底禁用无用包（极致精简）                    │
# └─────────────────────────────────────────────┘

# 无线全部禁用
CONFIG_PACKAGE_hostapd=n
CONFIG_PACKAGE_hostapd-common=n
CONFIG_PACKAGE_wpad=n
CONFIG_PACKAGE_wpad-basic=n
CONFIG_PACKAGE_wpad-mini=n
CONFIG_PACKAGE_iw=n
CONFIG_PACKAGE_iwinfo=n
CONFIG_PACKAGE_kmod-cfg80211=n
CONFIG_PACKAGE_kmod-mac80211=n
CONFIG_PACKAGE_kmod-ath=n
CONFIG_PACKAGE_kmod-ath9k=n
CONFIG_PACKAGE_kmod-mt76=n
CONFIG_PACKAGE_kmod-rt2800=n

# USB 全部禁用（虚拟机不需要）
CONFIG_PACKAGE_kmod-usb-core=n
CONFIG_PACKAGE_kmod-usb-ohci=n
CONFIG_PACKAGE_kmod-usb-uhci=n
CONFIG_PACKAGE_kmod-usb2=n
CONFIG_PACKAGE_kmod-usb3=n
CONFIG_PACKAGE_kmod-usb-storage=n
CONFIG_PACKAGE_kmod-usb-serial=n
CONFIG_PACKAGE_kmod-usb-serial-ftdi=n

# Samba / KSMBd 彻底禁用（你特别要求的）
CONFIG_PACKAGE_samba4-server=n
CONFIG_PACKAGE_samba4-client=n
CONFIG_PACKAGE_samba4-admin=n
CONFIG_PACKAGE_samba4-utils=n
# CONFIG_PACKAGE_kmod-fs-ksmbd=n
# CONFIG_PACKAGE_ksmbd-server=n
# CONFIG_PACKAGE_ksmbd-utils=n
# CONFIG_PACKAGE_luci-app-ksmbd=n
# CONFIG_PACKAGE_luci-i18n-ksmbd-zh-cn=n
CONFIG_PACKAGE_luci-app-samba=n
CONFIG_PACKAGE_luci-app-samba4=n

# NFS / 硬盘相关（虚拟机用不到）
CONFIG_PACKAGE_kmod-fs-nfs=n
CONFIG_PACKAGE_kmod-fs-nfsd=n
CONFIG_PACKAGE_kmod-fs-nfs-common=n
CONFIG_PACKAGE_nfs-utils=n
CONFIG_PACKAGE_luci-app-hd-idle=n
CONFIG_PACKAGE_hdparm=n

# UPnP
CONFIG_PACKAGE_miniupnpd=y
CONFIG_PACKAGE_luci-app-upnp=y

# 其他常见臃肿插件全部砍掉
CONFIG_PACKAGE_luci-app-adbyby-plus=n
CONFIG_PACKAGE_luci-app-unblockmusic=n
CONFIG_PACKAGE_luci-app-xlnetacc=n
CONFIG_PACKAGE_luci-app-zerotier=n
CONFIG_PACKAGE_luci-app-ipsec-vpnd=n
CONFIG_PACKAGE_luci-app-vsftpd=n
CONFIG_PACKAGE_luci-app-minidlna=n
CONFIG_PACKAGE_luci-app-statistics=n
CONFIG_PACKAGE_collectd=n
CONFIG_PACKAGE_luci-app-nlbwmon=n
CONFIG_PACKAGE_luci-app-wol=n
CONFIG_PACKAGE_luci-app-qbittorrent=n
CONFIG_PACKAGE_luci-app-transmission=n
CONFIG_PACKAGE_luci-app-dockerman=n
CONFIG_PACKAGE_luci-app-diskman=n
CONFIG_PACKAGE_luci-app-ttyd=n
CONFIG_PACKAGE_luci-app-wireguard=n
CONFIG_PACKAGE_luci-app-frpc=n
CONFIG_PACKAGE_luci-app-frps=n
CONFIG_PACKAGE_luci-app-ddns=n
CONFIG_PACKAGE_luci-app-accesscontrol=n

# ┌─────────────────────────────────────────────┐
# │ 编译优化选项                                  │
# └─────────────────────────────────────────────┘
CONFIG_KERNEL_BUILD_DOMAIN="vm.local"
CONFIG_KERNEL_BUILD_USER="openwrt"
CONFIG_GCC_USE_VERSION_11=y
CONFIG_GCC_VERSION_11=y
CONFIG_GCC_USE_GRAPHITE=y
CONFIG_KERNEL_GZIP=y

# 关闭调试（减小体积）
CONFIG_KERNEL_DEBUG_FS=n
CONFIG_KERNEL_DEBUG_KERNEL=n
CONFIG_KERNEL_DEBUG_INFO=n

# ==================================================
# 编译完成后 .gz 镜像通常 180~220MB
# 启动内存占用 150~200MB，性能拉满
# 完美适配所有主流虚拟化平台
# ==================================================