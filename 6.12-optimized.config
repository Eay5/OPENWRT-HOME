# ==================================================
# OpenWrt 6.12 优化配置 - Linux虚拟机专用版
# 针对 KVM/QEMU/Proxmox 等虚拟化平台优化
# 主要功能：SSR-Plus + MosDNS + SmartDNS
# ==================================================

# ┌─────────────────────────────────────────────┐
# │             目标平台配置                      │
# └─────────────────────────────────────────────┘
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_generic=y

# ┌─────────────────────────────────────────────┐
# │           固件镜像构建配置                    │
# └─────────────────────────────────────────────┘
CONFIG_GRUB_IMAGES=y
CONFIG_GRUB_TIMEOUT="3"
CONFIG_GRUB_TITLE="OpenWrt 6.12 Optimized"
CONFIG_PACKAGE_grub2-efi=y
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_TARGET_ROOTFS_PARTSIZE=1024  # 根分区1GB
CONFIG_TARGET_KERNEL_PARTSIZE=32

# ┌─────────────────────────────────────────────┐
# │         内核优化 (虚拟机专用)                 │
# └─────────────────────────────────────────────┘
# 虚拟化支持
CONFIG_VIRTUALIZATION=y
CONFIG_KVM_GUEST=y
CONFIG_PARAVIRT=y
CONFIG_PARAVIRT_SPINLOCKS=y
CONFIG_HYPERVISOR_GUEST=y

# CPU优化
CONFIG_CPU_FREQ=y
CONFIG_CPU_FREQ_DEFAULT_GOV_PERFORMANCE=y
CONFIG_CPU_FREQ_GOV_PERFORMANCE=y
CONFIG_CPU_FREQ_GOV_ONDEMAND=y

# 内存优化
CONFIG_TRANSPARENT_HUGEPAGE=y
CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS=y
CONFIG_ZSWAP=y
CONFIG_ZPOOL=y
CONFIG_Z3FOLD=y

# ┌─────────────────────────────────────────────┐
# │      虚拟机网络驱动 (精简优化)               │
# └─────────────────────────────────────────────┘
# VirtIO驱动 (KVM/QEMU必备)
CONFIG_PACKAGE_kmod-virtio=y
CONFIG_PACKAGE_kmod-virtio-net=y
CONFIG_PACKAGE_kmod-virtio-blk=y
CONFIG_PACKAGE_kmod-virtio-scsi=y
CONFIG_PACKAGE_kmod-virtio-balloon=y
CONFIG_PACKAGE_kmod-virtio-random=y

# 基础虚拟网卡
CONFIG_PACKAGE_kmod-e1000=y
CONFIG_PACKAGE_kmod-e1000e=y

# 禁用物理网卡驱动 (虚拟机不需要)
CONFIG_PACKAGE_kmod-igc=n
CONFIG_PACKAGE_kmod-r8125=n
CONFIG_PACKAGE_kmod-r8168=n
CONFIG_PACKAGE_kmod-ixgbe=n
CONFIG_PACKAGE_kmod-igb=n

# ┌─────────────────────────────────────────────┐
# │            网络优化配置                       │
# └─────────────────────────────────────────────┘
# TCP优化
CONFIG_PACKAGE_kmod-tcp-bbr=y
CONFIG_PACKAGE_kmod-tcp-hybla=y

# 网络加速
CONFIG_PACKAGE_kmod-shortcut-fe=y
CONFIG_PACKAGE_kmod-shortcut-fe-cm=y
CONFIG_PACKAGE_kmod-fast-classifier=y

# IPv6支持
CONFIG_PACKAGE_ipv6helper=y
CONFIG_PACKAGE_odhcpd-ipv6only=y
CONFIG_PACKAGE_odhcp6c=y
CONFIG_PACKAGE_6in4=y
CONFIG_PACKAGE_6rd=y
CONFIG_PACKAGE_6to4=y

# ┌─────────────────────────────────────────────┐
# │        防火墙和流量控制                       │
# └─────────────────────────────────────────────┘
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_iptables-mod-tproxy=y
CONFIG_PACKAGE_iptables-mod-extra=y
CONFIG_PACKAGE_iptables-mod-nat-extra=y
CONFIG_PACKAGE_iptables-mod-conntrack-extra=y
CONFIG_PACKAGE_kmod-ipt-tproxy=y
CONFIG_PACKAGE_kmod-ipt-nat=y
CONFIG_PACKAGE_kmod-ipt-conntrack=y
CONFIG_PACKAGE_kmod-nf-conntrack=y
CONFIG_PACKAGE_kmod-nf-conntrack-netlink=y

# ┌─────────────────────────────────────────────┐
# │         SSR-Plus 优化配置                     │
# └─────────────────────────────────────────────┘
# SSR-Plus主程序
CONFIG_PACKAGE_luci-app-ssr-plus=y
CONFIG_PACKAGE_luci-i18n-ssr-plus-zh-cn=y

# Shadowsocks Rust版本 (性能最优)
CONFIG_PACKAGE_shadowsocks-rust=y
CONFIG_PACKAGE_shadowsocks-rust-sslocal=y
CONFIG_PACKAGE_shadowsocks-rust-ssserver=y
CONFIG_PACKAGE_shadowsocks-rust-ssurl=y
CONFIG_PACKAGE_shadowsocks-rust-ssmanager=y

# SSR支持
CONFIG_PACKAGE_shadowsocksr-libev=y
CONFIG_PACKAGE_shadowsocksr-libev-ssr-local=y
CONFIG_PACKAGE_shadowsocksr-libev-ssr-redir=y
CONFIG_PACKAGE_shadowsocksr-libev-ssr-server=y
CONFIG_PACKAGE_shadowsocksr-libev-ssr-check=y

# V2ray/Xray (精简版)
CONFIG_PACKAGE_xray-core=y
CONFIG_PACKAGE_xray-plugin=y
CONFIG_PACKAGE_v2ray-geoip=y
CONFIG_PACKAGE_v2ray-geosite=y

# Trojan
CONFIG_PACKAGE_trojan-plus=y
CONFIG_PACKAGE_trojan-go=y

# 混淆和加密
CONFIG_PACKAGE_simple-obfs=y
CONFIG_PACKAGE_simple-obfs-client=y
CONFIG_PACKAGE_kcptun-client=y
CONFIG_PACKAGE_kcptun-config=y

# 透明代理优化
CONFIG_PACKAGE_redsocks2=y
CONFIG_PACKAGE_microsocks=y
CONFIG_PACKAGE_ipt2socks=y
CONFIG_PACKAGE_dns2socks=y
CONFIG_PACKAGE_dns2tcp=y

# 分流和路由
CONFIG_PACKAGE_chinadns-ng=y
CONFIG_PACKAGE_pdnsd-alt=y
CONFIG_PACKAGE_tcping=y
CONFIG_PACKAGE_resolveip=y

# ┌─────────────────────────────────────────────┐
# │      MosDNS + SmartDNS 优化配置              │
# └─────────────────────────────────────────────┘
# MosDNS (主DNS)
CONFIG_PACKAGE_mosdns=y
CONFIG_PACKAGE_luci-app-mosdns=y
CONFIG_PACKAGE_luci-i18n-mosdns-zh-cn=y

# SmartDNS (辅DNS)
CONFIG_PACKAGE_smartdns=y
CONFIG_PACKAGE_luci-app-smartdns=y
CONFIG_PACKAGE_luci-i18n-smartdns-zh-cn=y

# DNS工具
CONFIG_PACKAGE_bind-dig=y
CONFIG_PACKAGE_bind-host=y
CONFIG_PACKAGE_drill=y
CONFIG_PACKAGE_knot-dig=y

# DNSmasq完整版
CONFIG_PACKAGE_dnsmasq-full=y
CONFIG_PACKAGE_dnsmasq_full_dhcp=y
CONFIG_PACKAGE_dnsmasq_full_dhcpv6=y
CONFIG_PACKAGE_dnsmasq_full_dnssec=y
CONFIG_PACKAGE_dnsmasq_full_auth=y
CONFIG_PACKAGE_dnsmasq_full_ipset=y
CONFIG_PACKAGE_dnsmasq_full_nftset=y
CONFIG_PACKAGE_dnsmasq_full_conntrack=y
CONFIG_PACKAGE_dnsmasq_full_noid=y
CONFIG_PACKAGE_dnsmasq_full_broken_rtc=y
CONFIG_PACKAGE_dnsmasq_full_tftp=y

# ┌─────────────────────────────────────────────┐
# │           基础系统工具                        │
# └─────────────────────────────────────────────┘
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_wget-ssl=y
CONFIG_PACKAGE_nano=y
CONFIG_PACKAGE_htop=y
CONFIG_PACKAGE_iftop=y
CONFIG_PACKAGE_nload=y
CONFIG_PACKAGE_vnstat=y
CONFIG_PACKAGE_tcpdump=y
CONFIG_PACKAGE_iperf3=y
CONFIG_PACKAGE_mtr=y
CONFIG_PACKAGE_ss=y
CONFIG_PACKAGE_lsof=y

# SSH
CONFIG_PACKAGE_openssh-sftp-server=y
CONFIG_PACKAGE_openssh-client=y
CONFIG_PACKAGE_openssh-keygen=y

# 系统优化工具
CONFIG_PACKAGE_zram-swap=y
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_e2fsprogs=y

# ┌─────────────────────────────────────────────┐
# │              LuCI界面配置                     │
# └─────────────────────────────────────────────┘
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-mod-admin-full=y
CONFIG_PACKAGE_luci-theme-argon=y
CONFIG_PACKAGE_luci-app-argon-config=y
CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y
CONFIG_PACKAGE_luci-i18n-opkg-zh-cn=y

# LuCI协议支持
CONFIG_PACKAGE_luci-proto-ipv6=y
CONFIG_PACKAGE_luci-proto-ppp=y

# ┌─────────────────────────────────────────────┐
# │         明确禁用的包 (节省空间)              │
# └─────────────────────────────────────────────┘
# 禁用无线相关
CONFIG_PACKAGE_hostapd=n
CONFIG_PACKAGE_hostapd-common=n
CONFIG_PACKAGE_wpad=n
CONFIG_PACKAGE_wpad-basic=n
CONFIG_PACKAGE_wpad-mini=n
CONFIG_PACKAGE_iw=n
CONFIG_PACKAGE_iwinfo=n
CONFIG_PACKAGE_kmod-cfg80211=n
CONFIG_PACKAGE_kmod-mac80211=n
CONFIG_PACKAGE_kmod-ath=n
CONFIG_PACKAGE_kmod-ath9k=n
CONFIG_PACKAGE_kmod-mt76=n
CONFIG_PACKAGE_kmod-rt2800=n

# 禁用USB相关 (虚拟机不需要)
CONFIG_PACKAGE_kmod-usb-core=n
CONFIG_PACKAGE_kmod-usb-ohci=n
CONFIG_PACKAGE_kmod-usb-uhci=n
CONFIG_PACKAGE_kmod-usb2=n
CONFIG_PACKAGE_kmod-usb3=n
CONFIG_PACKAGE_kmod-usb-storage=n

# 禁用不需要的应用
CONFIG_PACKAGE_luci-app-adbyby-plus=n
CONFIG_PACKAGE_luci-app-unblockmusic=n
CONFIG_PACKAGE_luci-app-xlnetacc=n
CONFIG_PACKAGE_luci-app-zerotier=n
CONFIG_PACKAGE_luci-app-ipsec-vpnd=n
CONFIG_PACKAGE_luci-app-vsftpd=n
CONFIG_PACKAGE_luci-app-samba=n
CONFIG_PACKAGE_luci-app-samba4=n
CONFIG_PACKAGE_luci-app-qbittorrent=n
CONFIG_PACKAGE_luci-app-transmission=n
CONFIG_PACKAGE_luci-app-dockerman=n
CONFIG_PACKAGE_luci-app-diskman=n
CONFIG_PACKAGE_luci-app-ttyd=n
CONFIG_PACKAGE_luci-app-wireguard=n
CONFIG_PACKAGE_luci-app-frpc=n
CONFIG_PACKAGE_luci-app-frps=n

# ┌─────────────────────────────────────────────┐
# │          编译优化选项                         │
# └─────────────────────────────────────────────┘
CONFIG_KERNEL_BUILD_DOMAIN="vm.local"
CONFIG_KERNEL_BUILD_USER="openwrt"
CONFIG_PACKAGE_TURBOACC_INCLUDE_SHORTCUT_FE=y
CONFIG_PACKAGE_TURBOACC_INCLUDE_BBR_CCA=y

# GCC优化
CONFIG_GCC_USE_VERSION_11=y
CONFIG_GCC_VERSION_11=y
CONFIG_GCC_USE_GRAPHITE=y

# 压缩优化
CONFIG_KERNEL_GZIP=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_SQUASHFS_BLOCK_SIZE=256

# 调试选项 (生产环境可禁用)
CONFIG_KERNEL_DEBUG_FS=n
CONFIG_KERNEL_DEBUG_KERNEL=n
CONFIG_KERNEL_DEBUG_INFO=n
CONFIG_PACKAGE_kmod-usb-serial=n
CONFIG_PACKAGE_kmod-usb-serial-ftdi=n

# ==================================================
# 优化说明：
# 1. 专为Linux虚拟机环境优化，去除物理硬件驱动
# 2. 使用Shadowsocks-Rust获得最佳性能
# 3. MosDNS作为主DNS，SmartDNS作为辅助
# 4. 启用TCP BBR和网络加速
# 5. 精简系统，只保留必要组件
# 6. 虚拟机内存和CPU优化
# ==================================================
