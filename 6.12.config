# ==================================================
# OpenWrt 配置 - 针对 x86_64 虚拟机优化
# ==================================================

# --------------------------------------------------
# 目标平台配置 (Target System Configuration)
# --------------------------------------------------
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_generic=y

# --------------------------------------------------
# 固件镜像构建配置 (Image Build Configuration)
# --------------------------------------------------
CONFIG_GRUB_IMAGES=y
CONFIG_PACKAGE_grub2-efi=y
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_TARGET_ROOTFS_PARTSIZE=1024

# --------------------------------------------------
# 基本系统和实用工具 (Base System & Utilities)
# --------------------------------------------------
CONFIG_PACKAGE_6in4=y                   # IPv6-in-IPv4 隧道支持
CONFIG_PACKAGE_curl=y                   # URL 传输命令行工具
CONFIG_PACKAGE_nano=y                   # 一个简单的文本编辑器
CONFIG_PACKAGE_wget=y                   # 非交互式网络下载器
CONFIG_PACKAGE_openssl-util=y           # OpenSSL 命令行工具
CONFIG_PACKAGE_snmpd=y                  # SNMP 守护进程 (用于网络监控)

# --------------------------------------------------
# 性能监控和调试工具 (Performance Monitoring & Debug)
# --------------------------------------------------
CONFIG_PACKAGE_htop=y                   # 系统资源监控
CONFIG_PACKAGE_iftop=y                  # 网络流量监控
CONFIG_PACKAGE_nload=y                  # 网络负载监控
CONFIG_PACKAGE_vnstat=y                 # 流量统计
CONFIG_PACKAGE_tcpdump=y                # 网络抓包工具
CONFIG_PACKAGE_conntrack-tools=y        # 连接跟踪工具
CONFIG_PACKAGE_iptraf-ng=y              # 网络统计分析
CONFIG_PACKAGE_iperf3=y                 # 网络性能测试
CONFIG_PACKAGE_speedtest-netperf=y      # 速度测试

# --------------------------------------------------
# 网络 - 驱动程序 (KVM/QEMU优化) (Networking - Drivers (KVM/QEMU Optimized))
# --------------------------------------------------
# --- KVM/QEMU高速网络驱动 ---
CONFIG_PACKAGE_kmod-virtio-net=y        # VirtIO 半虚拟化网卡驱动 (KVM/QEMU必须)
CONFIG_PACKAGE_kmod-vhost-net=y         # vhost-net后端加速 (提升50%性能)
CONFIG_PACKAGE_kmod-tun=y               # TUN/TAP设备支持
CONFIG_PACKAGE_kmod-veth=y              # 虚拟以太网对
# --- 禁用不需要的驱动 ---
CONFIG_PACKAGE_kmod-e1000=n             # 移除旧模拟驱动
CONFIG_PACKAGE_kmod-e1000e=n            # 移除PCIe模拟驱动
CONFIG_PACKAGE_kmod-vmxnet3=n           # 移除VMware驱动

# --- 物理网络驱动 (典型虚拟机场景下禁用) ---
CONFIG_PACKAGE_kmod-igc=n               # Intel I225/I226 2.5G 网卡驱动 (除非使用PCI直通, 否则禁用)
CONFIG_PACKAGE_kmod-r8125=n             # Realtek RTL8125 2.5G 网卡驱动 (除非使用PCI直通, 否则禁用)

# --------------------------------------------------
# 网络 - 存储驱动 (虚拟机优化) (Networking - Storage Drivers (VM Optimized))
# --------------------------------------------------
CONFIG_PACKAGE_kmod-virtio-blk=y        # VirtIO 块存储驱动 (KVM/QEMU/Proxmox)
CONFIG_PACKAGE_kmod-virtio-scsi=y       # VirtIO SCSI 存储驱动 (KVM/QEMU/Proxmox)

# --------------------------------------------------
# 网络 - 服务与协议 (Networking - Services & Protocols)
# --------------------------------------------------
# --- IPv6 支持 ---
CONFIG_PACKAGE_ipv6helper=y             # IPv6 辅助工具
CONFIG_PACKAGE_luci-proto-ipv6=y        # LuCI 界面的 IPv6 协议支持
CONFIG_PACKAGE_luci-proto-ppp=y         # LuCI 界面的 PPP 协议支持 (含 PPPoE)
CONFIG_PACKAGE_odhcpd-ipv6only=y        # DHCPv6 服务器
CONFIG_PACKAGE_odhcp6c=y                # DHCPv6 客户端

# --- 防火墙 (使用旧版 iptables) ---
CONFIG_PACKAGE_iptables=y               # 包含 iptables 工具集
CONFIG_PACKAGE_firewall4=n             # 禁用 firewall4 (基于 nftables 的新防火墙)。请确保所选插件与 iptables 兼容!

# --- SSH/SFTP ---
CONFIG_PACKAGE_openssh-sftp-server=y    # 通过 OpenSSH 提供 SFTP 服务

# --- UPnP 支持 (修复依赖问题) ---
CONFIG_PACKAGE_miniupnpd=y              # UPnP 守护进程
CONFIG_PACKAGE_luci-app-upnp=y          # UPnP 管理界面

# --------------------------------------------------
# LuCI 网页界面及应用 (LuCI Web Interface & Applications)
# --------------------------------------------------
# --- LuCI 核心 ---
# (假设基础 LuCI 包如 luci, luci-base, luci-lib-ipkg 等默认已包含)

# --- LuCI 主题 ---
CONFIG_PACKAGE_luci-theme-argon=y       # Argon 主题包本身
CONFIG_PACKAGE_luci-app-argon-config=y  # Argon 主题配置工具

# --- LuCI 应用 (启用) ---
CONFIG_PACKAGE_luci-app-lucky=n         # Lucky - DDNS 及端口转发工具
CONFIG_PACKAGE_luci-app-smartdns=y      # SmartDNS - DNS 优化与分流器
CONFIG_PACKAGE_luci-app-ssr-plus=y      # ShadowsocksR Plus+ 客户端 (启用)
CONFIG_PACKAGE_luci-i18n-ssr-plus-zh-cn=y # SSR Plus 中文语言包
CONFIG_PACKAGE_luci-app-passwall=n      # Passwall 代理客户端 (禁用)
# CONFIG_PACKAGE_luci-i18n-passwall-zh-cn is not set  # Passwall 中文语言包

# --- LuCI 应用 (明确禁用) ---
CONFIG_PACKAGE_luci-app-adbyby-plus=n   # adbyby 广告过滤
CONFIG_PACKAGE_luci-app-adguardhome=n   # AdGuard Home DNS 广告过滤
CONFIG_PACKAGE_luci-app-accesscontrol=n # 访问控制
CONFIG_PACKAGE_luci-app-autoreboot=n    # 自动重启
CONFIG_PACKAGE_luci-app-bandwidthd=n    # 带宽监控 (旧版)
CONFIG_PACKAGE_luci-app-bypass=n        # Bypass (类似 VSSR 或 Passwall 的另一代理工具)
CONFIG_PACKAGE_luci-app-ddns=n          # 动态 DNS (官方版)
CONFIG_PACKAGE_luci-app-ddns-go=n       # DDNS-Go 动态 DNS
CONFIG_PACKAGE_luci-app-ddnsto=n        # DDNSTO 内网穿透
CONFIG_PACKAGE_luci-app-diskman=n       # 磁盘管理
CONFIG_PACKAGE_luci-app-dockerman=n     # Docker 容器管理
CONFIG_PACKAGE_luci-app-fchomo=n        # Fchomo 代理工具
CONFIG_PACKAGE_luci-app-fileassistant=n # 文件助手
CONFIG_PACKAGE_luci-app-filetransfer=n  # 文件传输
CONFIG_PACKAGE_luci-app-frpc=n          # FRP 客户端
CONFIG_PACKAGE_luci-app-frps=n          # FRP 服务端
CONFIG_PACKAGE_luci-app-godproxy=n      # GodProxy 代理
CONFIG_PACKAGE_luci-app-ipsec-vpnd=n    # IPSec VPN 服务端
CONFIG_PACKAGE_luci-app-mosdns=y        # MosDNS - DNS 分流器 (启用)
CONFIG_PACKAGE_luci-app-netdata=n       # Netdata 系统监控
CONFIG_PACKAGE_luci-app-nlbwmon=n       # 网络带宽监控
CONFIG_PACKAGE_luci-app-openclash=n     # OpenClash - Clash 客户端
# (已启用 Passwall 代替 SSR Plus+)
CONFIG_PACKAGE_luci-app-qbittorrent=n   # qBittorrent 下载器
CONFIG_PACKAGE_luci-app-samba=n         # Samba (旧版, 文件共享)
CONFIG_PACKAGE_luci-app-samba4=n        # Samba4 (新版, 文件共享)
CONFIG_PACKAGE_luci-app-socat=n         # Socat 网络工具中继
CONFIG_PACKAGE_luci-app-sqm=n           # SQM QoS (智能队列管理)
CONFIG_PACKAGE_luci-app-statistics=n    # 系统状态统计
CONFIG_PACKAGE_luci-app-store=n         # OpenWrt 应用商店 (非官方)
CONFIG_PACKAGE_luci-app-transmission=n  # Transmission 下载器
CONFIG_PACKAGE_luci-app-ttyd=n          # TTYD 网页终端
CONFIG_PACKAGE_luci-app-unblockmusic=n  # 解锁网易云灰色歌曲
CONFIG_PACKAGE_luci-app-vlmcsd=n        # KMS 激活服务器
CONFIG_PACKAGE_luci-app-vsftpd=n        # Vsftpd FTP 服务器的 LuCI 界面
CONFIG_PACKAGE_luci-app-wireguard=n     # WireGuard VPN
CONFIG_PACKAGE_luci-app-wol=n           # 网络唤醒 (Wake on LAN)
CONFIG_PACKAGE_luci-app-xlnetacc=n      # 迅雷快鸟加速
CONFIG_PACKAGE_luci-app-zerotier=n      # ZeroTier 内网穿透

# --------------------------------------------------
# SSR-Plus 相关包 (SSR-Plus Required Packages)
# --------------------------------------------------
# SSR-Plus 核心依赖（高性能优化配置）
CONFIG_PACKAGE_shadowsocks-rust=y       # Rust版本（更高性能）
CONFIG_PACKAGE_shadowsocks-rust-sslocal=y
CONFIG_PACKAGE_shadowsocks-rust-ssserver=y
CONFIG_PACKAGE_shadowsocks-libev=y
CONFIG_PACKAGE_shadowsocks-libev-ss-server=y
CONFIG_PACKAGE_shadowsocks-libev-ss-local=y
CONFIG_PACKAGE_shadowsocks-libev-ss-redir=y
CONFIG_PACKAGE_shadowsocks-libev-ss-tunnel=y
CONFIG_PACKAGE_shadowsocksr-libev-ssr-local=y
CONFIG_PACKAGE_shadowsocksr-libev-ssr-redir=y
CONFIG_PACKAGE_shadowsocksr-libev-ssr-server=y
# SSR-Plus 多线程和连接池优化
CONFIG_SHADOWSOCKS_RUST_THREADS=8       # Rust版本8线程支持
CONFIG_SHADOWSOCKS_RUST_MAX_CLIENTS=2048 # 最大客户端连接数(增加)
CONFIG_SHADOWSOCKS_RUST_TIMEOUT=600     # 连接超时时间
CONFIG_SHADOWSOCKS_RUST_NOFILE=65535    # 文件描述符限制
# 内存优化
CONFIG_SHADOWSOCKS_RUST_TCP_FAST_OPEN=y # TCP快速打开
CONFIG_SHADOWSOCKS_RUST_TCP_NODELAY=y   # 禁用Nagle算法
CONFIG_SHADOWSOCKS_RUST_TCP_KEEPALIVE=60 # TCP保活时间
CONFIG_PACKAGE_simple-obfs=y
CONFIG_PACKAGE_simple-obfs-client=y
CONFIG_PACKAGE_simple-obfs-server=y     # obfs服务端支持
CONFIG_PACKAGE_v2ray-core=y
CONFIG_PACKAGE_v2ray-plugin=y
CONFIG_PACKAGE_xray-core=y
CONFIG_PACKAGE_xray-plugin=y
# --- Xray性能优化 ---
CONFIG_XRAY_CORE_COMPRESS_UPX=n         # 不压缩（提升启动速度）
CONFIG_PACKAGE_trojan-plus=y
CONFIG_PACKAGE_trojan-go=y
# CONFIG_PACKAGE_naiveproxy=n  # 仓库中不存在
CONFIG_PACKAGE_redsocks2=y
# CONFIG_PACKAGE_kcptun=n  # 仓库中不存在
# CONFIG_PACKAGE_microsocks=n  # 仓库中不存在
CONFIG_PACKAGE_ipt2socks=y
CONFIG_PACKAGE_tcping=y
CONFIG_PACKAGE_libudns=y

# --------------------------------------------------
# 其他禁用的包 (系统层面) (Other Disabled Packages (System Level))
# --------------------------------------------------
CONFIG_PACKAGE_acpid=n                  # ACPI 守护进程 (虚拟机中通常不需要)
CONFIG_PACKAGE_autosamba=n              # 自动发现 Samba 共享
CONFIG_PACKAGE_block-mount=n            # 块设备挂载工具 (如果需要挂载额外虚拟磁盘, 设为=y)
CONFIG_DOCKER_OPTIONAL_FEATURES=n
CONFIG_PACKAGE_geoview=n                # GeoIP 查看工具 (曾报告有依赖问题)
CONFIG_PACKAGE_nikki=n                  # 未知包 'nikki' (曾报告有依赖问题)
# CONFIG_PACKAGE_vsftpd=n               # Vsftpd FTP 服务器 (已启用基于 SSH 的 SFTP)

# --------------------------------------------------
# 内存管理优化 (Memory Management Optimization)
# --------------------------------------------------
# --- 内存压缩和交换优化 ---
CONFIG_KERNEL_ZSWAP=y                   # 内存压缩交换
CONFIG_KERNEL_ZPOOL=y                   # 压缩内存池
CONFIG_KERNEL_ZBUD=y                    # zbud压缩算法
CONFIG_KERNEL_Z3FOLD=y                  # z3fold压缩算法
CONFIG_KERNEL_ZSMALLOC=y                # zsmalloc内存分配器
CONFIG_KERNEL_LZ4_COMPRESS=y            # LZ4压缩算法
CONFIG_KERNEL_LZO_COMPRESS=y            # LZO压缩算法

# --- 大页内存优化 ---
CONFIG_KERNEL_TRANSPARENT_HUGEPAGE=y    # 透明大页
CONFIG_KERNEL_TRANSPARENT_HUGEPAGE_ALWAYS=y
CONFIG_KERNEL_HUGETLBFS=y              # 大页文件系统
CONFIG_KERNEL_HUGETLB_PAGE=y           # 大页支持

# --- 内存调度优化 ---
CONFIG_KERNEL_MEMCG=y                   # 内存控制组
CONFIG_KERNEL_MEMCG_SWAP=y              # 交换内存控制
CONFIG_KERNEL_MEMCG_KMEM=y              # 内核内存控制
CONFIG_KERNEL_CGROUP_MEM_RES_CTLR=y    # 内存资源控制器

# --------------------------------------------------
# Intel x86 CPU性能优化 (Intel x86 CPU Optimization)
# --------------------------------------------------
# --- Intel专属指令集优化 ---
CONFIG_TARGET_OPTIMIZATION="-O3 -pipe -march=x86-64-v3 -mtune=generic"  # x86-64-v3支持AVX2
CONFIG_KERNEL_CC_OPTIMIZE_FOR_PERFORMANCE=y      # 性能优先编译
CONFIG_KERNEL_MCORE2=y                          # Intel Core优化
CONFIG_KERNEL_X86_INTEL_USERCOPY=y              # Intel优化的内存拷贝
CONFIG_KERNEL_X86_INTEL_TSX_MODE_ON=y           # Intel TSX事务内存

# --- Intel虚拟化优化 ---
CONFIG_PACKAGE_kmod-kvm-intel=y                 # Intel VT-x支持
CONFIG_KERNEL_KVM_INTEL=y                       # KVM Intel模块
CONFIG_KERNEL_INTEL_TXT=y                       # Intel TXT安全启动

# --- Intel网卡驱动（如果有PCI直通）---
CONFIG_PACKAGE_kmod-igb=y                       # Intel千兆网卡
CONFIG_PACKAGE_kmod-ixgbe=y                     # Intel万兆网卡

# --- AES-NI加密加速 ---
CONFIG_PACKAGE_kmod-crypto-aes=y                # AES加密
CONFIG_PACKAGE_kmod-crypto-aead=y               # AEAD加密
CONFIG_PACKAGE_kmod-crypto-aes-x86_64=y         # x86_64 AES优化
CONFIG_PACKAGE_kmod-cryptodev=y                 # 加密设备支持
CONFIG_OPENSSL_ENGINE_CRYPTO=y                  # OpenSSL加密引擎
CONFIG_OPENSSL_ENGINE_DIGEST=y                  # OpenSSL摘要引擎
CONFIG_OPENSSL_WITH_ASM=y                       # 汇编优化
CONFIG_OPENSSL_WITH_SSE2=y                      # SSE2优化

# --------------------------------------------------
# 高速网络加速模块 (High-Speed Network Acceleration)
# --------------------------------------------------
# --- Netfilter Offload加速 ---
CONFIG_PACKAGE_kmod-nf-flow=y           # Flow Offload硬件加速
CONFIG_PACKAGE_kmod-ipt-offload=y       # iptables硬件卸载

# --- TCP加速 ---
CONFIG_PACKAGE_kmod-tcp-bbr=y           # BBR拥塞控制算法
CONFIG_PACKAGE_kmod-tcp-bbr2=y          # BBRv2算法
CONFIG_PACKAGE_kmod-tcp-hybla=y         # Hybla算法（高延迟优化）

# --- Turbo ACC网络加速 ---
CONFIG_PACKAGE_luci-app-turboacc=y      # Turbo ACC加速管理
CONFIG_PACKAGE_kmod-shortcut-fe=y       # Shortcut-FE加速引擎
CONFIG_PACKAGE_kmod-shortcut-fe-cm=y    # SFE连接管理器
CONFIG_PACKAGE_kmod-fast-classifier=y   # 快速分类器

# --------------------------------------------------
# 代理工具额外依赖和冲突解决 (Proxy Tools Dependencies & Conflict Resolution)
# --------------------------------------------------
# 确保 ipset 支持
CONFIG_PACKAGE_ipset=y
CONFIG_PACKAGE_libipset13=y

# 确保 iptables 模块支持
CONFIG_PACKAGE_iptables-mod-tproxy=y
CONFIG_PACKAGE_iptables-mod-extra=y
CONFIG_PACKAGE_kmod-ipt-tproxy=y

# DNS基础架构配置
CONFIG_PACKAGE_dnsmasq-full=y           # 完整版dnsmasq（必须）
CONFIG_PACKAGE_dnsmasq=n                # 禁用基础版
CONFIG_PACKAGE_dnsmasq_full_dhcp=y      # DHCP服务
CONFIG_PACKAGE_dnsmasq_full_dhcpv6=y    # DHCPv6
CONFIG_PACKAGE_dnsmasq_full_dnssec=y    # DNSSEC支持
CONFIG_PACKAGE_dnsmasq_full_auth=y      # 认证DNS
CONFIG_PACKAGE_dnsmasq_full_ipset=y     # ipset支持
CONFIG_PACKAGE_dnsmasq_full_conntrack=y # 连接跟踪
CONFIG_PACKAGE_dnsmasq_full_noid=y      # 去除ID
CONFIG_PACKAGE_dnsmasq_full_broken_rtc=y # RTC修复

# MosDNS配置（主DNS解析器）
CONFIG_PACKAGE_mosdns=y
CONFIG_PACKAGE_luci-i18n-mosdns-zh-cn=y
CONFIG_PACKAGE_v2ray-geoip=y            # GeoIP数据
CONFIG_PACKAGE_v2ray-geosite=y          # GeoSite数据

# SmartDNS配置（辅助DNS解析器）
CONFIG_PACKAGE_smartdns=y
CONFIG_PACKAGE_luci-i18n-smartdns-zh-cn=y

# SSR-Plus DNS辅助工具
CONFIG_PACKAGE_pdnsd-alt=n              # 与MosDNS冲突，禁用
CONFIG_PACKAGE_chinadns-ng=y            # 保留作为备用
CONFIG_PACKAGE_dns2socks=y              # DNS转SOCKS
CONFIG_PACKAGE_dns2tcp=y                # DNS over TCP
CONFIG_PACKAGE_bind-dig=y               # dig命令
CONFIG_PACKAGE_bind-host=y              # host命令
# 负载均衡（可选，占用资源较多）
CONFIG_PACKAGE_haproxy=n                # HAProxy负载均衡器（单WAN不需要）
CONFIG_PACKAGE_mwan3=n                  # 多WAN负载均衡（单WAN不需要）
CONFIG_PACKAGE_luci-app-mwan3=n         # mwan3管理界面

# 禁用可能冲突的代理工具
CONFIG_PACKAGE_luci-app-passwall2=n
CONFIG_PACKAGE_luci-app-vssr=n
CONFIG_PACKAGE_luci-app-shadowsocks=n

# 确保依赖库（性能优化）
CONFIG_PACKAGE_libopenssl=y
CONFIG_PACKAGE_libopenssl-afalg=y       # 硬件加密加速
CONFIG_PACKAGE_libopenssl-devcrypto=y   # 加密设备支持
CONFIG_OPENSSL_OPTIMIZE_SPEED=y         # OpenSSL速度优化
CONFIG_OPENSSL_WITH_ASYNC=y             # 异步操作支持
CONFIG_PACKAGE_libpthread=y
CONFIG_PACKAGE_libpcre=y
CONFIG_PACKAGE_libpcre2=y               # PCRE2支持
CONFIG_PACKAGE_zlib=y
CONFIG_PACKAGE_libev=y
CONFIG_PACKAGE_libevent2=y              # libevent2支持
CONFIG_PACKAGE_libmbedtls=y
CONFIG_PACKAGE_libsodium=y              # libsodium加密库
CONFIG_PACKAGE_libboost=y
CONFIG_PACKAGE_libcap=y
CONFIG_PACKAGE_libcap-ng=y              # libcap-ng支持
CONFIG_PACKAGE_libnetfilter-conntrack=y # netfilter连接跟踪
CONFIG_PACKAGE_libnettle=y              # nettle加密库

# ==================================================
# 配置结束 (End of Configuration)
# ==================================================
